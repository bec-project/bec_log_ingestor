on:
  pull_request:
  push:
    branches:
      - main


name: Check and Lint

jobs:
  check:
    name: Check
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - uses: actions/checkout@v2
      - uses: actions-rs/toolchain@v1
        with:
          profile: minimal
          toolchain: stable
          override: true
      - uses: actions-rs/cargo@v1
        with:
          command: check

  fmt:
    name: Rustfmt
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v2
      - uses: actions-rs/toolchain@v1
        with:
          profile: minimal
          toolchain: stable
          override: true
      - run: rustup component add rustfmt
      - uses: actions-rs/cargo@v1
        with:
          command: fmt
          args: --all -- --check

  clippy:
    name: Clippy
    runs-on: ubuntu-latest
    permissions:
      checks: write
      contents: write
    steps:
      - uses: actions/checkout@v3
      - uses: dtolnay/rust-toolchain@stable
        with:
            components: clippy
      - uses: auguwu/clippy-action@1.4.0
        with:
            token: ${{secrets.GITHUB_TOKEN}}
                  
  test-build-rpm:
    name: Test cross compilation and RPM build
    runs-on: "ubuntu-latest"
    env:
      AWS_LC_SYS_CMAKE_BUILDER: 1
    steps:

    - name: Checkout
      uses: actions/checkout@v5

    - name: Install Rust toolchain
      uses: dtolnay/rust-toolchain@master
      with:
        toolchain: stable

    - name: Cache Rust dependencies
      uses: Swatinem/rust-cache@v2
    
    - name: Build RPM
      run: |
        cargo install cross
        cross build --release
        strip -s target/x86_64-unknown-linux-gnu/release/bec_log_ingestor
        cargo install cargo-generate-rpm
        cargo generate-rpm --signing-key=<(echo "${{ secrets.RPM_SIGNING_KEY }}")
    
    - uses: actions/upload-artifact@v4
      with:
        name: Test binary artifact and RPM
        path: |
          target/x86_64-unknown-linux-gnu/release/bec_log_ingestor
          target/generate-rpm/*.rpm